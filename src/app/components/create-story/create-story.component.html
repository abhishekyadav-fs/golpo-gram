<div class="create-story-container">
  <div class="create-story-card">
    <h2 class="page-title">Share Your Story<span *ngIf="userName">, {{ userName }}</span></h2>

    <!-- Story Type Selection -->
    <div class="story-type-selection" *ngIf="!storyType">
      <p class="selection-prompt">How would you like to share your story?</p>
      <div class="type-options">
        <button type="button" class="type-option-btn" (click)="selectStoryType('text')">
          <span class="material-symbols-outlined">edit_note</span>
          <span class="option-title">Write Story</span>
          <span class="option-description">Share your story with text and images</span>
        </button>
        <button type="button" class="type-option-btn" (click)="selectStoryType('audio')">
          <span class="material-symbols-outlined">mic</span>
          <span class="option-title">Audio Story</span>
          <span class="option-description">Record or upload your voice</span>
        </button>
      </div>
    </div>

    <!-- Text Story Form -->
    <form *ngIf="storyType === 'text'" [formGroup]="storyForm" (ngSubmit)="onSubmit()" class="story-form">
      <!-- Title -->
      <div class="form-group">
        <label for="title">Story Title *</label>
        <input
          id="title"
          type="text"
          formControlName="title"
          class="form-control"
          placeholder="Enter an engaging title"
        />
        <div class="error-message" *ngIf="storyForm.get('title')?.invalid && storyForm.get('title')?.touched">
          <span *ngIf="storyForm.get('title')?.errors?.['required']">Title is required</span>
          <span *ngIf="storyForm.get('title')?.errors?.['minlength']">Title must be at least 5 characters</span>
        </div>
      </div>

      <!-- Cover Image -->
      <div class="form-group">
        <label for="cover-image">Cover Image</label>
        <div class="cover-upload-area" *ngIf="!coverImagePreview">
          <input
            type="file"
            id="cover-image"
            (change)="onCoverImageSelect($event)"
            accept="image/*"
            hidden
          />
          <label for="cover-image" class="cover-upload-label">
            <span class="material-symbols-outlined">image</span>
            <span>Upload Cover Image</span>
            <span class="hint">Max 2MB</span>
          </label>
        </div>
        <div class="cover-preview" *ngIf="coverImagePreview">
          <img [src]="coverImagePreview" alt="Cover preview" />
          <button type="button" class="btn-remove-cover" (click)="removeCoverImage()">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Description *</label>
        <textarea
          id="description"
          formControlName="description"
          class="form-control"
          rows="3"
          placeholder="Brief description of your story (20-500 characters)"
          maxlength="500"
        ></textarea>
        <div class="char-count">{{ storyForm.get('description')?.value?.length || 0 }}/500</div>
        <div class="error-message" *ngIf="storyForm.get('description')?.invalid && storyForm.get('description')?.touched">
          <span *ngIf="storyForm.get('description')?.errors?.['required']">Description is required</span>
          <span *ngIf="storyForm.get('description')?.errors?.['minlength']">Description must be at least 20 characters</span>
        </div>
      </div>

      <!-- Genre and Language -->
      <div class="form-row">
        <div class="form-group">
          <label for="genre">Genre *</label>
          <select id="genre" formControlName="genre" class="form-control">
            <option value="">Select a genre</option>
            <option *ngFor="let genre of genres" [value]="genre.name">
              {{ genre.name }}
            </option>
          </select>
          <div class="error-message" *ngIf="storyForm.get('genre')?.invalid && storyForm.get('genre')?.touched">
            Genre is required
          </div>
        </div>

        <div class="form-group">
          <label for="language">Language *</label>
          <select id="language" formControlName="language" class="form-control">
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- Locality -->
      <div class="form-group">
        <label for="locality_id">Locality *</label>
        <select
          id="locality_id"
          formControlName="locality_id"
          class="form-control"
        >
          <option value="">Select a locality</option>
          <option *ngFor="let locality of localities" [value]="locality.id">
            {{ locality.name }}
          </option>
        </select>
        <div class="error-message" *ngIf="storyForm.get('locality_id')?.invalid && storyForm.get('locality_id')?.touched">
          Locality is required
        </div>
      </div>

      <!-- Main Characters -->
      <div class="form-group">
        <label>Main Characters (Optional)</label>
        <div class="characters-list" formArrayName="main_characters">
          <div class="character-item" *ngFor="let char of mainCharacters.controls; let i = index">
            <input
              type="text"
              [formControlName]="i"
              class="form-control"
              placeholder="Character name"
            />
            <button type="button" class="btn-remove-char" (click)="removeCharacter(i)">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
        <button type="button" class="btn-add-character" (click)="addCharacter()" *ngIf="mainCharacters.length < 10">
          <span class="material-symbols-outlined">add</span>
          Add Character
        </button>
      </div>

      <!-- Tags -->
      <div class="form-group">
        <label for="tags">Tags</label>
        <div class="tags-input-container">
          <div class="selected-tags">
            <span class="tag-chip" *ngFor="let tag of selectedTags; let i = index">
              {{ tag.name }}
              <button type="button" (click)="removeTag(i)">Ã—</button>
            </span>
          </div>
          <input
            type="text"
            id="tags"
            [(ngModel)]="tagInput"
            [ngModelOptions]="{standalone: true}"
            class="form-control"
            placeholder="Type and press Enter to add tags"
            (keydown.enter)="$event.preventDefault(); addTag()"
          />
        </div>
        <div class="tag-suggestions" *ngIf="tagInput">
          <span
            class="tag-suggestion"
            *ngFor="let tag of filterTags()"
            (click)="selectTag(tag)"
          >
            {{ tag.name }} ({{ tag.usage_count }})
          </span>
        </div>
      </div>

      <!-- Rich Text Editor -->
      <div class="form-group">
        <label for="content">Story Content *</label>
        <div class="rich-text-toolbar">
          <button type="button" class="toolbar-btn" (click)="execCommand('bold')" title="Bold">
            <span class="material-symbols-outlined">format_bold</span>
          </button>
          <button type="button" class="toolbar-btn" (click)="execCommand('italic')" title="Italic">
            <span class="material-symbols-outlined">format_italic</span>
          </button>
          <button type="button" class="toolbar-btn" (click)="execCommand('underline')" title="Underline">
            <span class="material-symbols-outlined">format_underlined</span>
          </button>
          <span class="toolbar-divider"></span>
          <button type="button" class="toolbar-btn" (click)="execCommand('insertUnorderedList')" title="Bullet List">
            <span class="material-symbols-outlined">format_list_bulleted</span>
          </button>
          <button type="button" class="toolbar-btn" (click)="execCommand('insertOrderedList')" title="Numbered List">
            <span class="material-symbols-outlined">format_list_numbered</span>
          </button>
        </div>
        <div
          #richTextEditor
          class="rich-text-editor"
          contenteditable="true"
          (input)="onEditorInput($event)"
          [attr.data-placeholder]="'Tell your story...'"
        ></div>
        <div class="word-count" [class.word-limit-exceeded]="wordCount > maxWords">
          {{ wordCount }}/{{ maxWords }} words
          <span *ngIf="wordCount > maxWords" class="limit-warning">Word limit exceeded!</span>
        </div>
        <div class="error-message" *ngIf="storyForm.get('content')?.invalid && storyForm.get('content')?.touched">
          <span *ngIf="storyForm.get('content')?.errors?.['required']">Content is required</span>
          <span *ngIf="storyForm.get('content')?.errors?.['minlength']">Content must be at least 20 characters</span>
        </div>
      </div>

      <!-- Story Inline Images (max 5, max 2MB each) -->
      <div class="form-group">
        <label>Add Images to Story (Max 5, up to 2MB each)</label>
        <div class="story-images-upload" *ngIf="storyImages.length < maxStoryImages">
          <input
            type="file"
            id="storyImagesInput"
            (change)="onStoryImageSelect($event)"
            accept="image/*"
            multiple
            hidden
          />
          <label for="storyImagesInput" class="story-images-upload-label">
            <span class="material-symbols-outlined">add_photo_alternate</span>
            Add Images ({{ storyImages.length }}/{{ maxStoryImages }})
          </label>
        </div>
        <div class="story-images-list" *ngIf="storyImages.length > 0">
          <div class="story-image-item" *ngFor="let img of storyImages; let i = index">
            <img [src]="img.preview" alt="Story image" />
            <div class="image-controls">
              <input
                type="text"
                [(ngModel)]="img.caption"
                [ngModelOptions]="{standalone: true}"
                placeholder="Caption (optional)"
                class="form-control-sm"
              />
              <div class="image-actions">
                <button type="button" class="btn-insert-image" (click)="insertImageAtCursor(i)" title="Insert at cursor">
                  <span class="material-symbols-outlined">arrow_insert</span>
                </button>
                <button type="button" class="btn-remove-image" (click)="removeStoryImage(i)" title="Remove">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Traditional Media Files (backward compatibility) -->
      <div class="form-group">
        <label>Add Media (Images, Audio, Video)</label>
        <div class="file-upload-area">
          <input
            type="file"
            id="fileInput"
            (change)="onFileSelect($event)"
            accept="image/*,video/*,audio/*"
            multiple
            hidden
          />
          <label for="fileInput" class="file-upload-label">
            <span class="upload-icon">ðŸ“Ž</span>
            Choose Files
          </label>
        </div>

        <div class="file-previews" *ngIf="filePreviews.length > 0">
          <div class="file-preview" *ngFor="let preview of filePreviews; let i = index">
            <img *ngIf="preview.type === 'image'" [src]="preview.url" alt="Preview" />
            <video *ngIf="preview.type === 'video'" [src]="preview.url" controls></video>
            <audio *ngIf="preview.type === 'audio'" [src]="preview.url" controls></audio>
            <div class="file-info">
              <span class="file-name">{{ preview.name }}</span>
              <button type="button" class="btn-remove" (click)="removeFile(i)">âœ•</button>
            </div>
          </div>
        </div>
      </div>

      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="success-message" *ngIf="successMessage">
        {{ successMessage }}
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="goBack()">
          Back
        </button>
        <button
          type="submit"
          class="btn-primary"
          [disabled]="storyForm.invalid || isLoading"
        >
          {{ isLoading ? 'Submitting...' : 'Submit Story' }}
        </button>
      </div>
    </form>

    <!-- Audio Story Form -->
    <form *ngIf="storyType === 'audio'" [formGroup]="audioStoryForm" (ngSubmit)="onSubmit()" class="story-form">
      <!-- Title -->
      <div class="form-group">
        <label for="audio-title">Story Title *</label>
        <input
          id="audio-title"
          type="text"
          formControlName="title"
          class="form-control"
          placeholder="Enter an engaging title"
        />
        <div class="error-message" *ngIf="audioStoryForm.get('title')?.invalid && audioStoryForm.get('title')?.touched">
          <span *ngIf="audioStoryForm.get('title')?.errors?.['required']">Title is required</span>
          <span *ngIf="audioStoryForm.get('title')?.errors?.['minlength']">Title must be at least 5 characters</span>
        </div>
      </div>

      <!-- Cover Image -->
      <div class="form-group">
        <label for="audio-cover-image">Cover Image</label>
        <div class="cover-upload-area" *ngIf="!coverImagePreview">
          <input
            type="file"
            id="audio-cover-image"
            (change)="onCoverImageSelect($event)"
            accept="image/*"
            hidden
          />
          <label for="audio-cover-image" class="cover-upload-label">
            <span class="material-symbols-outlined">image</span>
            <span>Upload Cover Image</span>
            <span class="hint">Max 2MB</span>
          </label>
        </div>
        <div class="cover-preview" *ngIf="coverImagePreview">
          <img [src]="coverImagePreview" alt="Cover preview" />
          <button type="button" class="btn-remove-cover" (click)="removeCoverImage()">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="audio-description">Description *</label>
        <textarea
          id="audio-description"
          formControlName="description"
          class="form-control"
          rows="3"
          placeholder="Brief description of your story (20-500 characters)"
          maxlength="500"
        ></textarea>
        <div class="char-count">{{ audioStoryForm.get('description')?.value?.length || 0 }}/500</div>
        <div class="error-message" *ngIf="audioStoryForm.get('description')?.invalid && audioStoryForm.get('description')?.touched">
          <span *ngIf="audioStoryForm.get('description')?.errors?.['required']">Description is required</span>
          <span *ngIf="audioStoryForm.get('description')?.errors?.['minlength']">Description must be at least 20 characters</span>
        </div>
      </div>

      <!-- Genre and Language -->
      <div class="form-row">
        <div class="form-group">
          <label for="audio-genre">Genre *</label>
          <select id="audio-genre" formControlName="genre" class="form-control">
            <option value="">Select a genre</option>
            <option *ngFor="let genre of genres" [value]="genre.name">
              {{ genre.name }}
            </option>
          </select>
          <div class="error-message" *ngIf="audioStoryForm.get('genre')?.invalid && audioStoryForm.get('genre')?.touched">
            Genre is required
          </div>
        </div>

        <div class="form-group">
          <label for="audio-language">Language *</label>
          <select id="audio-language" formControlName="language" class="form-control">
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- Locality -->
      <div class="form-group">
        <label for="audio-locality_id">Locality *</label>
        <select
          id="audio-locality_id"
          formControlName="locality_id"
          class="form-control"
        >
          <option value="">Select a locality</option>
          <option *ngFor="let locality of localities" [value]="locality.id">
            {{ locality.name }}
          </option>
        </select>
        <div class="error-message" *ngIf="audioStoryForm.get('locality_id')?.invalid && audioStoryForm.get('locality_id')?.touched">
          Locality is required
        </div>
      </div>

      <!-- Main Characters -->
      <div class="form-group">
        <label>Main Characters (Optional)</label>
        <div class="characters-list" formArrayName="main_characters">
          <div class="character-item" *ngFor="let char of mainCharacters.controls; let i = index">
            <input
              type="text"
              [formControlName]="i"
              class="form-control"
              placeholder="Character name"
            />
            <button type="button" class="btn-remove-char" (click)="removeCharacter(i)">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
        <button type="button" class="btn-add-character" (click)="addCharacter()" *ngIf="mainCharacters.length < 10">
          <span class="material-symbols-outlined">add</span>
          Add Character
        </button>
      </div>

      <!-- Tags -->
      <div class="form-group">
        <label for="audio-tags">Tags</label>
        <div class="tags-input-container">
          <div class="selected-tags">
            <span class="tag-chip" *ngFor="let tag of selectedTags; let i = index">
              {{ tag.name }}
              <button type="button" (click)="removeTag(i)">Ã—</button>
            </span>
          </div>
          <input
            type="text"
            id="audio-tags"
            [(ngModel)]="tagInput"
            [ngModelOptions]="{standalone: true}"
            class="form-control"
            placeholder="Type and press Enter to add tags"
            (keydown.enter)="$event.preventDefault(); addTag()"
          />
        </div>
        <div class="tag-suggestions" *ngIf="tagInput">
          <span
            class="tag-suggestion"
            *ngFor="let tag of filterTags()"
            (click)="selectTag(tag)"
          >
            {{ tag.name }} ({{ tag.usage_count }})
          </span>
        </div>
      </div>

      <!-- Audio Upload/Recording -->
      <div class="form-group">
        <label>Audio Story *</label>
        
        <!-- Audio Options Selection -->
        <div class="audio-options" *ngIf="!audioFile && !isRecording && !recordedBlob">
          <button type="button" class="audio-option-btn" (click)="showUploadAudio()">
            <span class="material-symbols-outlined">upload_file</span>
            Upload Audio File
          </button>
          <button type="button" class="audio-option-btn" (click)="startRecording()">
            <span class="material-symbols-outlined">mic</span>
            Record Audio
          </button>
        </div>

        <!-- Audio Upload -->
        <div class="audio-upload-area" *ngIf="showUpload && !audioFile">
          <input
            type="file"
            id="audioFileInput"
            (change)="onAudioFileSelect($event)"
            accept="audio/mp3,audio/wav,audio/ogg,audio/m4a,audio/aac,audio/mpeg"
            hidden
          />
          <label for="audioFileInput" class="audio-upload-label">
            <span class="material-symbols-outlined">cloud_upload</span>
            <span>Choose Audio File</span>
            <span class="supported-formats">Supported: MP3, WAV, OGG, M4A, AAC</span>
          </label>
        </div>

        <!-- Audio Recording Controls -->
        <div class="audio-recording" *ngIf="isRecording">
          <div class="recording-indicator">
            <span class="recording-dot"></span>
            <span class="recording-text">Recording... {{ recordingDuration }}</span>
          </div>
          <div class="recording-visualizer">
            <div class="visualizer-bar" *ngFor="let bar of visualizerBars" [style.height.%]="bar"></div>
          </div>
          <button type="button" class="btn-stop-recording" (click)="stopRecording()">
            <span class="material-symbols-outlined">stop_circle</span>
            Stop Recording
          </button>
        </div>

        <!-- Audio Preview -->
        <div class="audio-preview" *ngIf="audioFile || recordedBlob">
          <div class="audio-player">
            <audio #audioPlayer [src]="audioPreviewUrl" controls></audio>
          </div>
          <div class="audio-info">
            <span class="audio-name">{{ audioFileName }}</span>
            <span class="audio-duration" *ngIf="audioDuration">{{ formatDuration(audioDuration) }}</span>
          </div>
          <button type="button" class="btn-remove-audio" (click)="removeAudio()">
            <span class="material-symbols-outlined">delete</span>
            Remove
          </button>
        </div>

        <div class="error-message" *ngIf="audioStoryForm.get('audio_url')?.invalid && audioStoryForm.get('audio_url')?.touched">
          Audio file is required
        </div>
      </div>

      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="success-message" *ngIf="successMessage">
        {{ successMessage }}
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="goBack()">
          Back
        </button>
        <button
          type="submit"
          class="btn-primary"
          [disabled]="audioStoryForm.invalid || isLoading || (!audioFile && !recordedBlob)"
        >
          {{ isLoading ? 'Submitting...' : 'Submit Audio Story' }}
        </button>
      </div>
    </form>
  </div>
</div>
